# 告警服务工控机部署指南

## 📦 部署流程

### 1. 本地环境（开发机）

#### 构建Docker镜像
```bash
cd packages/
chmod +x build_image.sh
./build_image.sh
```

**构建输出：**
- 镜像名称：`voltageems-alarmsrv:1.0.0`
- 打包文件：`voltageems-alarmsrv-1.0.0.tar.gz`
- 目标架构：`linux/arm64` (aarch64)

### 2. 传输到工控机

将打包文件传输到工控机：
```bash
# 方式1：scp传输
scp voltageems-alarmsrv-1.0.0.tar.gz user@工控机IP:/path/to/deploy/

# 方式2：U盘/物理传输
# 将tar.gz文件复制到U盘，然后在工控机上拷贝
```

### 3. 工控机部署

#### 加载镜像
```bash
chmod +x load_image.sh start.sh
./load_image.sh
```

**加载功能：**
- 自动查找`voltageems-alarmsrv-*.tar.gz`文件
- 停止并删除现有容器和镜像
- 加载新镜像并创建`latest`标签

#### 启动服务
```bash
./start.sh
```

**启动功能：**
- 智能选择最新版本镜像
- 检查Redis连接状态
- 创建数据持久化目录
- 启动容器并验证服务状态

## 🔧 配置说明

### 环境变量配置

| 变量名 | 默认值 | 说明 |
|--------|--------|------|
| `REDIS_HOST` | `localhost` | Redis服务器地址 |
| `REDIS_PORT` | `6379` | Redis端口 |
| `REDIS_PREFIX` | `alarmsrv:` | Redis键前缀 |
| `DATABASE_PATH` | `/app/config/voltageems-alarm.db` | SQLite数据库路径 |
| `DEBUG` | `false` | 调试模式 |
| `LOG_LEVEL` | `INFO` | 日志级别 |

### 数据持久化

| 宿主机路径 | 容器路径 | 用途 |
|-----------|----------|------|
| `/extp/config/` | `/app/config/` | 数据库文件存储 |
| `/extp/logs/` | `/app/logs/` | 日志文件存储 |

## 🚀 服务信息

### 端口和访问地址
- **服务端口：** 6002
- **健康检查：** http://localhost:6002/health
- **API文档：** http://localhost:6002/docs

### 容器管理命令
```bash
# 查看服务状态
docker ps | grep alarmsrv

# 查看日志
docker logs voltageems-alarmsrv

# 重启服务
docker restart voltageems-alarmsrv

# 停止服务
docker stop voltageems-alarmsrv

# 查看服务详情
docker inspect voltageems-alarmsrv
```

## 🔍 故障排查

### 1. 服务启动失败
```bash
# 查看详细日志
docker logs voltageems-alarmsrv -f

# 检查端口占用
netstat -tulpn | grep 6002

# 检查容器状态
docker ps -a | grep alarmsrv
```

### 2. 数据库问题
```bash
# 检查数据库文件
ls -la /extp/config/voltageems-alarm.db*

# 进入容器查看
docker exec -it voltageems-alarmsrv /bin/bash
```

### 3. Redis连接问题
```bash
# 测试Redis连接
redis-cli ping

# 检查Redis状态
systemctl status redis
```

## 📊 数据备份

### 备份数据库
```bash
# 备份SQLite数据库
cp /extp/config/voltageems-alarm.db /path/to/backup/voltageems-alarm-$(date +%Y%m%d).db
```

### 备份日志
```bash
# 压缩备份日志
tar -czf /path/to/backup/alarmsrv-logs-$(date +%Y%m%d).tar.gz /extp/logs/
```

## 🔄 版本升级

1. 在开发机构建新版本镜像
2. 传输新的tar.gz文件到工控机
3. 运行`./load_image.sh`加载新镜像
4. 运行`./start.sh`启动新版本

**注意：** 升级过程中会自动停止旧版本，数据库和日志文件会保留。

## 🛡️ 安全建议

1. **修改默认密钥：** 在生产环境中修改`JWT_SECRET_KEY`
2. **网络安全：** 确保只有授权用户可以访问6002端口
3. **定期备份：** 建议每日备份数据库文件
4. **日志监控：** 定期检查服务日志，及时发现异常
5. **Redis安全：** 确保Redis服务配置了适当的安全策略

## 📋 部署检查清单

- [ ] Docker已安装并运行
- [ ] Redis服务正常运行
- [ ] 网络6002端口可用
- [ ] `/extp/config/`和`/extp/logs/`目录权限正确
- [ ] 镜像文件传输完整
- [ ] 服务启动成功并通过健康检查
- [ ] API接口可正常访问
- [ ] 数据库自动创建成功
